

tinymce.PluginManager.add('uploadimage', function (ed, url) {
    url = tinyMCE.activeEditor.getParam('uploadimage_rel') || url;
    var uploadimageUrl = tinyMCE.activeEditor.getParam('uploadimage_url');
    console.log('url'+uploadimageUrl)
    var $win;
    function showdiago() {
        var win = ed.windowManager.open({
            title: '插入图片',
            width: 400,
            height: 100,
            html: ['<body><link rel="stylesheet" type="text/css" href="' + url + '/css/style.css"> ' +
            ' <div class="uploadimageContainer  ">' +
            ' <div class="uploadimageContainerInner">' +
            '                            <form action="' + uploadimageUrl + '" method="POST"  enctype="multipart/form-data" id="uploadImageForm">' +
            '                            <div class="mce-container uploadimageFormContainer" hidefocus="1" tabindex="-1">' +
            '                                <div class="mce-container-body">' +
            '                                    <input type="file" name="file"  id="upload" class="mce-textbox" hidefocus="true" style="width: 258px;">' +
            '                               </div>' +
            '                                <p class="uploadimageError"></p>' +
            '                            </div>' +
            '                            </form>' +
            '                        </div>' +
            '                    </div>' +
            '</body>'].join(""),
            buttons: [{
                text: ' 插入图片 ',
                subtype: 'primary',
                style: 'width:88px',
                onclick: function () {
                    uploadsimgs();

                }
            },
                {
                    text: 'Close',
                    onclick: 'close'
                }]

        });


        function uploadsimgs() {

            var showuploadimageError = function (msg) {
                $('.uploadimageError').html(msg).show();
            };


            var submitUpload = function () {
                var index ;
                $('#uploadImageForm').ajaxSubmit({
                    dataType: 'json',
                    beforeSend:function(){
                          index = layer.load(0, {shade: false , offset: '400px'},{time:3000});
                    },
                    success: function (response) {
                        layer.close(index);
                        console.log("1" + response)
                        if (response == null || response == undefined) {
                            layer.msg('上传出错：1', {
                                title:'提示'
                                //不自动关闭
                                ,time:1000
                                ,icon:5
                                , offset: '400px'
                            });
                            // showuploadimageError('上传出错：1');
                        }
                        else {
                            if (response.status ==0) {
                                // switch (response.error) {
                                //     case ("filetype"):
                                // showuploadimageError(response.message);
                                layer.msg('上传出错：3'+response.message, {
                                    title:'提示'
                                    //不自动关闭
                                    ,time:1000
                                    ,icon:5
                                    , offset: '400px'
                                });
                                //     break;
                                // default:
                                //     showuploadimageError('未知错误：1');
                                //     break;
                                // }
                            }
                            else {
                                if (response.cdnurl != undefined) {
                                    layer.msg('插入成功', {
                                        title:'提示'
                                        //不自动关闭
                                        ,time:1000
                                        ,icon:6
                                        , offset: '400px'
                                    });
                                    var tpl = '<img src="//%s" />';
                                    var tmppath = response.cdnurl;
                                    console.log(tmppath);
                                    // tmppath = tmppath.replace('D:\\phpStudy\\WWW\\jwblog\\public\\', 'jwblog/public/');
                                    // console.log(tmppath);
                                    ed.insertContent(tpl.replace('%s', tmppath));
                                    ed.focus();
                                    win.close();
                                } else{
                                    layer.msg('未知错误：3', {
                                        title:'提示'
                                        //不自动关闭
                                        ,time:1000
                                        ,icon:5
                                        , offset: '400px'
                                    });
                                    // showuploadimageError('未知错误：3');
                                }
                            }
                        }
                    },
                    error: function () {
                        layer.close(index);
                    layer.msg('上传错误：-1', {
                        title:'提示'
                        //不自动关闭
                        ,time:1000
                        ,icon:5
                        , offset: '400px'
                    });
                        // showuploadimageError('上传错误：-1');
                    }
                });
            }
            submitUpload();


        }
    }
// Register commands
    ed.addCommand('uploadimage', showdiago);


// Register buttons
    ed.addButton('uploadimage', {
        title: '插入图片',
        cmd: 'uploadimage',
        image: url + '/img/icon.png',
    });


})
;