tinymce.PluginManager.add('uploadvideo', function (ed, url) {
    url = tinyMCE.activeEditor.getParam('uploadvideo_rel') || url;

    var uploadvideoUrl = tinyMCE.activeEditor.getParam('uploadvideo_url');

    var $win;

    function showdiago() {
        var win = ed.windowManager.open({
            title: '插入视频',
            width: 400,
            height: 100,
            html: ['<body><link rel="stylesheet" type="text/css" href="' + url + '/css/style.css"> ' +
            ' <div class="uploadvideoContainer  ">' +
            ' <div class="uploadvideoContainerInner">' +
            '                            <form action="' + uploadvideoUrl + '" method="POST"  enctype="multipart/form-data" id="uploadvideoForm">' +
            '                            <div class="mce-container uploadvideoFormContainer" hidefocus="1" tabindex="-1">' +
            '                                <div class="mce-container-body">' +
            '                                    <input type="file" name="file"  class="mce-textbox mce-placeholder" hidefocus="true" style="width: 258px;">' +
            '                               </div>' +
            '                                <p class="uploadvideoError"></p>' +
            '                            </div>' +
            '                            </form>' +
            '                        </div>' +
            '                    </div>' +
            '</body>'].join(""),
            buttons: [{
                text: ' 插入视频',
                subtype: 'primary',
                style: 'width:88px',
                onclick: function () {
                    uploadsimgs();

                }
            },
                {
                    text: 'Close',
                    onclick: 'close'
                }]

        });


        function uploadsimgs() {

            var showuploadvideoError = function (msg) {
                $('.uploadvideoError').html(msg).show();
            };


            var submitUpload = function () {
                var index ,indextip;
                $('#uploadvideoForm').ajaxSubmit({
                    dataType: 'json',
                    beforeSend:function(){
                        index = layer.load(0, {shade: false , offset: '400px'},{time:3000});
                        indextip=layer.msg('正在上传视频...',{time:999999,shade: false , offset: '450px'})

                    },
                    success: function (response) {
                        layer.close(index);
                        layer.close(indextip)
                        console.log(response)
                        if (response == null || response == undefined) {

                            layer.msg('上传出错：1', {
                                title:'提示'
                                //不自动关闭
                                ,time:1000
                                ,icon:5
                                , offset: '400px'
                            });
                        }
                        else {
                            if (response.status ==0) {
                                layer.msg('上传出错：3'+response.message, {
                                    title:'提示'
                                    //不自动关闭
                                    ,time:1000
                                    ,icon:5
                                    , offset: '400px'
                                });
                            }
                            else {
                                if (response.cdnurl != undefined) {
                                    layer.msg('插入成功', {
                                        title:'提示'
                                        //不自动关闭
                                        ,time:1000
                                        ,icon:6
                                        , offset: '400px'
                                    });
                                    var tpl = '<video width="320" height="240" controls="controls">' +
                                        '<source src="//%s" type="video/mp4"></video>';
                                    var tmppath = response.cdnurl;
                                    console.log(tmppath);
                                    ed.insertContent(tpl.replace('%s', tmppath));
                                    ed.focus();
                                    win.close();
                                } else {
                                    layer.msg('未知错误：3', {
                                        title:'提示'
                                        //不自动关闭
                                        ,time:1000
                                        ,icon:5
                                        , offset: '400px'
                                    });
                                }
                            }
                        }
                    },
                    error: function () {
                        layer.close(index);
                        layer.close(indextip)
                        layer.msg('上传出错：-1', {
                            title:'提示'
                            //不自动关闭
                            ,time:1000
                            ,icon:5
                            , offset: '400px'
                        });
                    }
                });
            }
            submitUpload();

        }
    }

// Register commands
    ed.addCommand('uploadvideo', showdiago);


// Register buttons
    ed.addButton('uploadvideo', {
        title: '插入视频',
        cmd: 'uploadvideo',
        icon: 'Media'
    });


})
;